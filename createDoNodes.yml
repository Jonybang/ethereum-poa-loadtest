- hosts: localhost
  gather_facts: yes
  tasks:
    - name: ensure key exists at DigitalOcean
      digital_ocean: >
        state=present
        command=ssh
        name="aura experiment key"
        ssh_pub_key={{ lookup('file', '~/.ssh/do.pub') }}
      register: my_ssh_key

    - digital_ocean: >
        name={{ item }}
        state=present
        command=droplet
        unique_name=yes
        size_id=1gb
        region_id={{ do_region }}
        image_id={{ do_image_id }}
        ssh_key_ids={{ my_ssh_key.ssh_key.id }}
      with_sequence: start=1 end={{ validators_count }} format=validator-%d
      register: droplet_details

    - debug:
        msg: "IP is {{ item.droplet.ip_address }}"
      with_items: "{{ droplet_details.results }}"

    - name: remove hosts.txt
      file:
        state: absent
        path: ./hosts.txt

    - name: create new hosts.txt
      lineinfile:
        path: ./hosts.txt
        line: "[validator]"
        create: yes

    - name: add dropet IPs to hosts.txt
      lineinfile:
        path: ./hosts.txt
        line: "{{ item.droplet.ip_address }} name={{ item.droplet.name }}"
      with_items: "{{ droplet_details.results }}"
